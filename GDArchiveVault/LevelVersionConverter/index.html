<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GD Block Filter Tool</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 30px;
}

#topButtons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

button {
  padding: 8px 14px;
  font-size: 16px;
  cursor: pointer;
}

#uploadArea {
  margin-top: 20px;
}

#downloadBtn {
  margin-top: 20px;
  display: none;
}
</style>
</head>
<body>

<h1>GD Block Filter Tool</h1>

<div id="topButtons"></div>

<div id="uploadArea">
  <button id="uploadBtn">Upload File</button>
  <p>Only Accepts GMD Files</p>
  <input type="file" id="fileInput" accept=".gmd" style="display:none;">
</div>

<button id="downloadBtn">Download Modified File</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

<script>
// -------------------------------
// ROW DEFINITIONS (NO TABLE)
// -------------------------------
const rows = [
  { label: "Filter A", number: 100 },
  { label: "Filter B", number: 200 },
  { label: "Filter C", number: 300 }
];

// -------------------------------
// BUILD BUTTONS
// -------------------------------
let selectedLimit = null;
const btnArea = document.getElementById("topButtons");

rows.forEach(row => {
  const btn = document.createElement("button");
  btn.textContent = row.label;
  btn.onclick = () => {
    selectedLimit = row.number;
    alert("Selected filter: " + row.label);
  };
  btnArea.appendChild(btn);
});

// -------------------------------
// UPLOAD HANDLING
// -------------------------------
document.getElementById("uploadBtn").onclick = () => {
  document.getElementById("fileInput").click();
};

document.getElementById("fileInput").addEventListener("change", async function() {
  if (!selectedLimit) {
    alert("Select a filter button first!");
    return;
  }

  const file = this.files[0];
  const text = await file.text();

  // Extract base64 from <k>k4</k><s>...</s>
  const base64 = text.match(/<k>k4<\/k><s>(.*?)<\/s>/)[1];

  // Decode → gunzip → XML
  const binary = atob(base64);
  const bytes = new Uint8Array([...binary].map(c => c.charCodeAt(0)));
  const xml = new TextDecoder().decode(pako.ungzip(bytes));

  // Extract object string (kS38)
  let objMatch = xml.match(/kS38.*?<s>(.*?)<\/s>/);
  if (!objMatch) { alert("No object data found."); return; }

  let objects = objMatch[1].split("|").filter(x => x.length > 0);

  // -------------------------------
  // FILTER BLOCKS
  // -------------------------------
  let filtered = objects.filter(obj => {
    let parts = obj.split(",");
    if (parts[0] !== "1") return true; // only block ID=1
    let second = parseInt(parts[1]);
    return second <= selectedLimit;
  });

  let newObjString = filtered.join("|") + "|";

  // Replace inside XML
  let newXML = xml.replace(objMatch[1], newObjString);

  // Recompress → base64
  const gz = pako.gzip(newXML);
  let b64 = btoa(String.fromCharCode(...gz));

  // Replace inside original file
  let newFile = text.replace(base64, b64);

  // -------------------------------
  // DOWNLOAD BUTTON
  // -------------------------------
  const dl = document.getElementById("downloadBtn");
  dl.style.display = "inline-block";
  dl.onclick = () => {
    const blob = new Blob([newFile], {type: "text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = file.name;
    a.click();
  };
});
</script>

</body>
</html>
